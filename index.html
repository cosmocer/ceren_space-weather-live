<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Live Space Weather Dashboard</title>
  <style>
    :root{
      --bg:#0b1220; --card:#121a2b; --muted:#8aa0c2; --text:#e7eefc; --accent:#5ec7ff; --warn:#ffd166; --alert:#ff6b6b; --ok:#7bd88f;
    }
    *{box-sizing:border-box}
    body{margin:0; font-family:Inter, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji"; background:linear-gradient(180deg,#0b1220,#0a1326); color:var(--text)}
    header{padding:18px 20px; display:flex; align-items:center; justify-content:space-between; gap:12px; border-bottom:1px solid #1e2a45}
    header h1{font-size:18px; margin:0; letter-spacing:.3px}
    header .updated{font-size:12px; color:var(--muted)}
    .container{max-width:1200px; margin:0 auto; padding:18px}
    .grid{display:grid; grid-template-columns:repeat(12,1fr); gap:14px}
    .card{background:var(--card); border:1px solid #1e2a45; border-radius:14px; padding:14px; box-shadow:0 6px 20px rgba(0,0,0,.25)}
    .card h2{margin:0 0 8px; font-size:14px; color:#cfe1ff; font-weight:600}
    .value{font-size:28px; font-weight:700}
    .sub{font-size:12px; color:var(--muted)}
    .row{display:flex; gap:12px; flex-wrap:wrap; align-items:baseline}
    .chip{font-size:12px; padding:4px 8px; border-radius:999px; border:1px solid #28466e; color:#cfe1ff}
    .ok{color:var(--ok); border-color:rgba(123,216,143,.35)}
    .warn{color:var(--warn); border-color:rgba(255,209,102,.35)}
    .alert{color:var(--alert); border-color:rgba(255,107,107,.35)}
    .col-3{grid-column:span 3}
    .col-4{grid-column:span 4}
    .col-6{grid-column:span 6}
    .col-8{grid-column:span 8}
    .col-12{grid-column:span 12}

    /* Simple sparkline */
    canvas{width:100%; height:54px}

    /* Aurora map */
    .aurora{display:grid; grid-template-columns:1fr; gap:8px}
    .aurora img{width:100%; border-radius:12px; border:1px solid #1e2a45}

    @media (max-width: 860px){
      .col-3,.col-4,.col-6,.col-8{grid-column:span 12}
      header{flex-direction:column; align-items:flex-start}
    }
    a{color:var(--accent); text-decoration:none}
    a:hover{text-decoration:underline}
  </style>
</head>
<body>
  <header>
    <h1>Live Space Weather</h1>
    <div class="updated" id="last-updated">Loading…</div>
  </header>
  <div class="container">
    <div class="grid">
      <!-- Kp index -->
      <section class="card col-3">
        <h2>Planetary Kp</h2>
        <div class="value" id="kp">—</div>
        <div class="sub" id="kp-time">—</div>
        <div class="row" id="kp-badges"></div>
      </section>

      <!-- GOES X-ray -->
      <section class="card col-3">
        <h2>GOES X‑ray Flux</h2>
        <div class="value" id="xray-class">—</div>
        <div class="sub" id="xray-time">—</div>
        <canvas id="xray-spark"></canvas>
        <div class="sub">Class scale: A < B < C < M < X</div>
      </section>

      <!-- Solar wind -->
      <section class="card col-6">
        <h2>Solar Wind </h2>
        <div class="row">
          <div>
            <div class="sub">Speed (km/s)</div>
            <div class="value" id="sw-speed">—</div>
          </div>
          <div>
            <div class="sub">Density (cm⁻³)</div>
            <div class="value" id="sw-density">—</div>
          </div>
          <div>
            <div class="sub">B<sub>z</sub> (nT)</div>
            <div class="value" id="sw-bz">—</div>
          </div>
          <div>
            <div class="sub">B<sub>t</sub> (nT)</div>
            <div class="value" id="sw-bt">—</div>
          </div>
        </div>
        <canvas id="speed-spark"></canvas>
      </section>

      <!-- Aurora -->
      <section class="card col-8">
        <h2>OVATION Aurora (Nowcast)</h2>
        <div class="aurora">
          <img id="aurora-nh" alt="Aurora forecast, Northern Hemisphere" src="https://services.swpc.noaa.gov/images/animations/ovation/north/latest.jpg" />
        </div>
        <div class="sub">Images courtesy of NOAA SWPC. Green, yellow, red correspond to higher auroral probability.
        </div>
      </section>

      <!-- Alerts feed -->
      <section class="card col-4">
        <h2>NOAA Watches/Warnings/Alerts</h2>
        <div id="alerts">Loading…</div>
        <div class="sub">Source: <a href="https://www.swpc.noaa.gov/" target="_blank" rel="noopener">NOAA SWPC</a></div>
      </section>

      <!-- Footer -->
      <section class="card col-12">
        <div class="sub">Auto‑refreshes every 60 seconds. Data from <a href="https://services.swpc.noaa.gov/" target="_blank" rel="noopener">services.swpc.noaa.gov</a>.
          All times show your local timezone.</div>
      </section>
    </div>
  </div>

  <script>
    const fmtTime = ts => new Date(ts).toLocaleString();

    function setUpdated(){
      document.getElementById('last-updated').textContent = 'Updated ' + new Date().toLocaleTimeString();
    }

    function badge(el, text, cls){
      const s = document.createElement('span');
      s.className = 'chip ' + (cls || '');
      s.textContent = text; el.appendChild(s);
    }

    function drawSpark(canvas, arr){
      const ctx = canvas.getContext('2d');
      const w = canvas.width = canvas.clientWidth * devicePixelRatio;
      const h = canvas.height = canvas.clientHeight * devicePixelRatio;
      ctx.clearRect(0,0,w,h);
      if(!arr || !arr.length) return;
      const min = Math.min(...arr), max = Math.max(...arr);
      const xstep = w / (arr.length - 1 || 1);
      ctx.lineWidth = 2 * devicePixelRatio; ctx.beginPath();
      arr.forEach((v,i)=>{
        const x = i * xstep;
        const y = h - ((v - min) / (max - min || 1)) * (h-4*devicePixelRatio) - 2*devicePixelRatio;
        if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
      });
      ctx.stroke();
    }

    // Kp index (3‑hourly definitive/estimated)
    async function loadKp(){
      const url = 'https://services.swpc.noaa.gov/products/noaa-planetary-k-index.json';
      const res = await fetch(url, {cache:'no-cache'});
      const data = await res.json();
      // First row is header. Use last non-header row.
      const row = data[data.length-1];
      const when = row[0]; const kp = parseFloat(row[1]);
      document.getElementById('kp').textContent = kp.toFixed(1);
      document.getElementById('kp-time').textContent = 'as of ' + fmtTime(when);
      const badges = document.getElementById('kp-badges'); badges.innerHTML='';
      if (kp < 4) badge(badges,'Quiet','ok');
      else if (kp < 5) badge(badges,'Unsettled','warn');
      else if (kp < 6) badge(badges,'G1 Minor storm','warn');
      else if (kp < 7) badge(badges,'G2 Moderate','alert');
      else if (kp < 8) badge(badges,'G3 Strong','alert');
      else if (kp < 9) badge(badges,'G4 Severe','alert');
      else badge(badges,'G5 Extreme','alert');
    }

    // GOES X‑ray (primary satellite, 1‑day, 1‑min cadence)
    function xrayClassFromFlux(flux){
      const levels = [
        {thr:1e-4, letter:'X'},
        {thr:1e-5, letter:'M'},
        {thr:1e-6, letter:'C'},
        {thr:1e-7, letter:'B'},
        {thr:1e-8, letter:'A'}
      ];
      for(const l of levels){ if(flux >= l.thr) return l.letter + (flux / l.thr).toFixed(2); }
      return 'A0.00';
    }

    async function loadXray(){
      const url = 'https://services.swpc.noaa.gov/json/goes/primary/xrays-1-day.json';
      const res = await fetch(url, {cache:'no-cache'});
      const data = await res.json();
      // Data objects: {time_tag, xrsa, xrsb}. Use long channel (xrsb, 1–8 Å)
      const fluxes = data.map(d=>Number(d.xrsb)).filter(Number.isFinite);
      const times = data.map(d=>d.time_tag);
      const latest = fluxes[fluxes.length-1];
      document.getElementById('xray-class').textContent = xrayClassFromFlux(latest);
      document.getElementById('xray-time').textContent = 'last GOES sample ' + fmtTime(times[times.length-1]);
      drawSpark(document.getElementById('xray-spark'), fluxes.slice(-180));
    }

    // Solar wind (DSCOVR, 15‑min plasma & mag if available). Use 1‑hour for robustness.
    async function loadSolarWind(){
      const plasmaUrl = 'https://services.swpc.noaa.gov/products/solar-wind/plasma-1-day.json';
      const magUrl = 'https://services.swpc.noaa.gov/products/solar-wind/mag-1-day.json';
      const [pRes, mRes] = await Promise.all([
        fetch(plasmaUrl, {cache:'no-cache'}), fetch(magUrl, {cache:'no-cache'})
      ]);
      const plasma = await pRes.json();
      const mag = await mRes.json();
      const pRow = plasma[plasma.length-1];
      const mRow = mag[mag.length-1];
      const speed = parseFloat(pRow[2]); // km/s
      const density = parseFloat(pRow[1]); // n/cc
      const bt = parseFloat(mRow[6]); // total field nT
      const bz = parseFloat(mRow[7]); // GSM Bz nT
      document.getElementById('sw-speed').textContent = isFinite(speed)? speed.toFixed(0): '—';
      document.getElementById('sw-density').textContent = isFinite(density)? density.toFixed(1): '—';
      document.getElementById('sw-bt').textContent = isFinite(bt)? bt.toFixed(1): '—';
      const bzEl = document.getElementById('sw-bz');
      if (isFinite(bz)){
        bzEl.textContent = bz.toFixed(1);
        bzEl.style.color = (bz < -3) ? 'var(--alert)' : (bz < 0 ? 'var(--warn)' : 'var(--ok)');
      } else { bzEl.textContent = '—'; }
      // Speed spark line
      const speeds = plasma.slice(-120).map(r=>parseFloat(r[2])).filter(v=>isFinite(v));
      drawSpark(document.getElementById('speed-spark'), speeds);
    }

    // Alerts feed (R,S,G scales etc.)
    async function loadAlerts(){
      const url = 'https://services.swpc.noaa.gov/products/alerts.json';
      const res = await fetch(url, {cache:'no-cache'});
      const data = await res.json();
      const root = document.getElementById('alerts');
      root.innerHTML = '';
      if(!Array.isArray(data) || data.length === 0){ root.textContent = 'No current alerts.'; return; }
      data.slice(1).forEach(a=>{
        const div = document.createElement('div');
        div.style.marginBottom = '10px';
        const when = fmtTime(a.issue_datetime || a.message_issue_datetime || a.event_begin);
        const cat = a.product_id || a.message_type || 'Alert';
        const txt = a.message || a.summary || a.description || JSON.stringify(a);
        div.innerHTML = `<span class="chip">${cat}</span> <span class="sub">${when}</span><br/>${txt.replace(/\n/g,'<br/>')}`;
        root.appendChild(div);
      });
    }

    async function refresh(){
      try{ await Promise.all([loadKp(), loadXray(), loadSolarWind(), loadAlerts()]); }
      catch(e){ console.error(e); }
      finally{ setUpdated(); }
    }

    // Bust image cache for aurora every minute by appending a noop query param
    function refreshAuroraImages(){
      const t = Date.now();
      for (const id of ['aurora-nh','aurora-sh']){
        const img = document.getElementById(id);
        const base = img.src.split('?')[0];
        img.src = base + '?_=' + t;
      }
    }

    refresh();
    refreshAuroraImages();
    setInterval(refresh, 60*1000);
    setInterval(refreshAuroraImages, 60*1000);
  </script>
</body>
</html>
