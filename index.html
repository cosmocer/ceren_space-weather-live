<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Live Space Weather Dashboard</title>
  <style>
    :root{
      /* Light theme */
      --bg:#f7f9fc; --card:#ffffff; --muted:#5a6b85; --text:#0b1b34; --accent:#0c6bff; --warn:#b15a00; --alert:#b00020; --ok:#1a7f37; --border:#e4e9f2;
    }
    *{box-sizing:border-box}
    body{margin:0; font-family:Inter, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica, Arial; background:var(--bg); color:var(--text)}
    header{padding:18px 20px; display:flex; align-items:center; justify-content:space-between; gap:12px; border-bottom:1px solid var(--border); background:#f1f5fb}
    header h1{font-size:18px; margin:0; letter-spacing:.3px}
    header .updated{font-size:12px; color:var(--muted)}
    .container{max-width:1200px; margin:0 auto; padding:18px}
    .grid{display:grid; grid-template-columns:repeat(12,1fr); gap:14px}
    .card{background:var(--card); border:1px solid var(--border); border-radius:14px; padding:14px; box-shadow:0 6px 20px rgba(10,20,40,.05)}
    .card h2{margin:0 0 8px; font-size:14px; color:#2b4a83; font-weight:700}
    .value{font-size:28px; font-weight:800}
    .sub{font-size:12px; color:var(--muted)}
    .row{display:flex; gap:12px; flex-wrap:wrap; align-items:baseline}
    .chip{font-size:12px; padding:4px 8px; border-radius:999px; border:1px solid #c8d4ea; color:#2b4a83; background:#eef3ff}
    .ok{color:var(--ok); border-color:rgba(26,127,55,.2); background:#ecf8f0}
    .warn{color:var(--warn); border-color:rgba(177,90,0,.2); background:#fff1e0}
    .alert{color:var(--alert); border-color:rgba(176,0,32,.2); background:#ffe9ee}
    .col-3{grid-column:span 3}
    .col-4{grid-column:span 4}
    .col-6{grid-column:span 6}
    .col-8{grid-column:span 8}
    .col-12{grid-column:span 12}

    canvas{width:100%; height:54px}

    .aurora{display:grid; grid-template-columns:1fr; gap:8px}
    .aurora img{width:100%; border-radius:12px; border:1px solid var(--border)}

    @media (max-width: 860px){
      .col-3,.col-4,.col-6,.col-8{grid-column:span 12}
      header{flex-direction:column; align-items:flex-start}
    }
    a{color:var(--accent); text-decoration:none}
    a:hover{text-decoration:underline}
    .imgcard img{width:100%; border:1px solid var(--border); border-radius:12px}
  </style>
</head>
<body>
  <header>
    <h1>Live Space Weather</h1>
    <div class="updated" id="last-updated">Loading…</div>
  </header>
  <div class="container">
    <div class="grid">
      <!-- Kp index -->
      <section class="card col-3">
        <h2>Planetary Kp</h2>
        <div class="value" id="kp">—</div>
        <div class="sub" id="kp-time">—</div>
        <div class="sub" id="kp-dmax">—</div>
        <div class="row" id="kp-badges"></div>
      </section>

      <!-- GOES X-ray -->
      <section class="card col-3">
        <h2>GOES X‑ray Flux</h2>
        <div class="value" id="xray-class">—</div>
        <div class="sub" id="xray-time">—</div>
        <div class="sub" id="xray-dmax">—</div>
        <canvas id="xray-spark"></canvas>
        <div class="sub">Class scale: A < B < C < M < X</div>
      </section>

      <!-- Solar wind (ACE) -->
      <section class="card col-6">
        <h2>Solar Wind (ACE)</h2>
        <div class="row">
          <div>
            <div class="sub">Speed (km/s)</div>
            <div class="value" id="sw-speed">—</div>
            <div class="sub" id="sw-speed-max">—</div>
          </div>
          <div>
            <div class="sub">Density (cm⁻³)</div>
            <div class="value" id="sw-density">—</div>
            <div class="sub" id="sw-density-max">—</div>
          </div>
          <div>
            <div class="sub">B<sub>z</sub> (nT)</div>
            <div class="value" id="sw-bz">—</div>
            <div class="sub" id="sw-bz-max">—</div>
          </div>
          <div>
            <div class="sub">B (nT)</div>
            <div class="value" id="sw-bt">—</div>
            <div class="sub" id="sw-bt-max">—</div>
          </div>
        </div>
        <canvas id="speed-spark"></canvas>
        <div class="sub">ACE SWE, MAG 1‑minute feeds via NOAA SWPC.</div>
      </section>

      <!-- Compact live metrics above OVATION -->
      <section class="card col-12" id="compact-metrics">
        <h2>Live Metrics</h2>
        <div class="row">
          <div class="chip">Vsw <span id="tiny-speed">—</span> km/s</div>
          <div class="chip">Np <span id="tiny-density">—</span> cm⁻³</div>
          <div class="chip">B <span id="tiny-bt">—</span> nT</div>
          <div class="chip">Bz <span id="tiny-bz">—</span> nT</div>
          <div class="chip">X‑ray <span id="tiny-xray">—</span></div>
        </div>
      </section>

      <!-- Aurora -->
      <section class="card col-8">
        <h2>OVATION Aurora (Nowcast)</h2>
        <div class="aurora">
          <img id="aurora-nh" alt="Aurora forecast, Northern Hemisphere" src="https://services.swpc.noaa.gov/images/animations/ovation/north/latest.jpg" />
          <img id="aurora-sh" alt="Aurora forecast, Southern Hemisphere" src="https://services.swpc.noaa.gov/images/animations/ovation/south/latest.jpg" />
        </div>
        <div class="sub">Images courtesy of NOAA SWPC. Green, yellow, red correspond to higher auroral probability.
        </div>
      </section>

      <!-- AE/AL (SuperMAG image) -->
      <section class="card col-4 imgcard">
        <h2>AE / AL (SuperMAG)</h2>
        <img id="aeal-img" alt="AE/AL recent plot" src=""/>
        <div class="sub">If the image does not load, open <a href="https://supermag.jhuapl.edu/mag/" target="_blank" rel="noopener">SuperMAG MAG</a>.
        </div>
      </section>

      <!-- SYM-H -->
      <section class="card col-4 imgcard">
        <h2>SYM‑H (Kyoto WDC)</h2>
        <img id="symh-img" alt="SYM-H recent plot" src=""/>
        <div class="sub">If the image does not load, open <a href="https://wdc.kugi.kyoto-u.ac.jp/aeasy/index.html" target="_blank" rel="noopener">Kyoto WDC</a>.
        </div>
      </section>

      <!-- Alerts feed -->
      <section class="card col-4">
        <h2>NOAA Watches/Warnings/Alerts</h2>
        <div id="alerts">Loading…</div>
        <div class="sub">Source: <a href="https://www.swpc.noaa.gov/" target="_blank" rel="noopener">NOAA SWPC</a></div>
      </section>

      <!-- Footer -->
      <section class="card col-12">
        <div class="sub">Auto‑refreshes every 60 seconds. Data from <a href="https://services.swpc.noaa.gov/" target="_blank" rel="noopener">services.swpc.noaa.gov</a>, SuperMAG, and Kyoto WDC. All times show your local timezone.</div>
      </section>
    </div>
  </div>
          <div>
            <div class="sub">Density (cm⁻³)</div>
            <div class="value" id="sw-density">—</div>
          </div>
          <div>
            <div class="sub">B<sub>z</sub> (nT)</div>
            <div class="value" id="sw-bz">—</div>
          </div>
          <div>
            <div class="sub">B<sub>t</sub> (nT)</div>
            <div class="value" id="sw-bt">—</div>
          </div>
        </div>
        <canvas id="speed-spark"></canvas>
        <div class="sub">ACE SWE, MAG 1‑minute feeds via NOAA SWPC.</div>
      </section>

      <!-- Aurora -->
      <section class="card col-8">
        <h2>OVATION Aurora (Nowcast)</h2>
        <div class="aurora">
          <img id="aurora-nh" alt="Aurora forecast, Northern Hemisphere" src="https://services.swpc.noaa.gov/images/animations/ovation/north/latest.jpg" />
          <img id="aurora-sh" alt="Aurora forecast, Southern Hemisphere" src="https://services.swpc.noaa.gov/images/animations/ovation/south/latest.jpg" />
        </div>
        <div class="sub">Images courtesy of NOAA SWPC. Green, yellow, red correspond to higher auroral probability.
        </div>
      </section>

      <!-- AE/AL (SuperMAG image) -->
      <section class="card col-4 imgcard">
        <h2>AE / AL (SuperMAG)</h2>
        <img id="aeal-img" alt="AE/AL recent plot" src=""/>
        <div class="sub">If the image does not load, open <a href="https://supermag.jhuapl.edu/mag/" target="_blank" rel="noopener">SuperMAG MAG</a>.
        </div>
      </section>

      <!-- SYM-H -->
      <section class="card col-4 imgcard">
        <h2>SYM‑H (Kyoto WDC)</h2>
        <img id="symh-img" alt="SYM-H recent plot" src=""/>
        <div class="sub">If the image does not load, open <a href="https://wdc.kugi.kyoto-u.ac.jp/aeasy/index.html" target="_blank" rel="noopener">Kyoto WDC</a>.
        </div>
      </section>

      <!-- Alerts feed -->
      <section class="card col-4">
        <h2>NOAA Watches/Warnings/Alerts</h2>
        <div id="alerts">Loading…</div>
        <div class="sub">Source: <a href="https://www.swpc.noaa.gov/" target="_blank" rel="noopener">NOAA SWPC</a></div>
      </section>

      <!-- Footer -->
      <section class="card col-12">
        <div class="sub">Auto‑refreshes every 60 seconds. Data from <a href="https://services.swpc.noaa.gov/" target="_blank" rel="noopener">services.swpc.noaa.gov</a>, SuperMAG, and Kyoto WDC. All times show your local timezone.</div>
      </section>
    </div>
  </div>

  <script>
    const fmtTime = ts => new Date(ts).toLocaleString();

    function setUpdated(){
      document.getElementById('last-updated').textContent = 'Updated ' + new Date().toLocaleTimeString();
    }

    function badge(el, text, cls){
      const s = document.createElement('span');
      s.className = 'chip ' + (cls || '');
      s.textContent = text; el.appendChild(s);
    }

    function drawSpark(canvas, arr){
      const ctx = canvas.getContext('2d');
      const w = canvas.width = canvas.clientWidth * devicePixelRatio;
      const h = canvas.height = canvas.clientHeight * devicePixelRatio;
      ctx.clearRect(0,0,w,h);
      if(!arr || !arr.length) return;
      const min = Math.min(...arr), max = Math.max(...arr);
      const xstep = w / (arr.length - 1 || 1);
      ctx.lineWidth = 2 * devicePixelRatio; ctx.beginPath();
      arr.forEach((v,i)=>{
        const x = i * xstep;
        const y = h - ((v - min) / (max - min || 1)) * (h-4*devicePixelRatio) - 2*devicePixelRatio;
        if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
      });
      ctx.stroke();
    }

    // Kp index (3‑hourly definitive/estimated)
    async function loadKp(){
      const url = 'https://services.swpc.noaa.gov/products/noaa-planetary-k-index.json';
      const res = await fetch(url, {cache:'no-cache'});
      const data = await res.json();
      const rows = data.slice(1); // drop header
      const last = rows[rows.length-1];
      const when = last[0]; const kp = parseFloat(last[1]);
      document.getElementById('kp').textContent = kp.toFixed(1);
      document.getElementById('kp-time').textContent = 'as of ' + fmtTime(when);
      // daily max (UTC)
      const todayUTC = new Date().toISOString().slice(0,10);
      let dmax = -Infinity;
      for(const r of rows){
        const day = String(r[0]).slice(0,10);
        const v = parseFloat(r[1]);
        if(day===todayUTC && isFinite(v)) dmax = Math.max(dmax, v);
      }
      const maxText = isFinite(dmax) ? `today max: ${dmax.toFixed(1)}` : 'today max: —';
      document.getElementById('kp-dmax').textContent = maxText;
      const badges = document.getElementById('kp-badges'); badges.innerHTML='';
      if (kp < 4) badge(badges,'Quiet','ok');
      else if (kp < 5) badge(badges,'Unsettled','warn');
      else if (kp < 6) badge(badges,'G1 Minor storm','warn');
      else if (kp < 7) badge(badges,'G2 Moderate','alert');
      else if (kp < 8) badge(badges,'G3 Strong','alert');
      else if (kp < 9) badge(badges,'G4 Severe','alert');
      else badge(badges,'G5 Extreme','alert');
    }

    // GOES X‑ray (1‑day, 1‑min cadence)
    function xrayClassFromFlux(flux){
      const levels = [
        {thr:1e-4, letter:'X'},
        {thr:1e-5, letter:'M'},
        {thr:1e-6, letter:'C'},
        {thr:1e-7, letter:'B'},
        {thr:1e-8, letter:'A'}
      ];
      for(const l of levels){ if(flux >= l.thr) return l.letter + (flux / l.thr).toFixed(2); }
      return 'A0.00';
    }

    async function loadXray(){
      const url = 'https://services.swpc.noaa.gov/json/goes/primary/xrays-1-day.json';
      const res = await fetch(url, {cache:'no-cache'});
      const data = await res.json();
      const fluxes = data.map(d=>Number(d.xrsb)).filter(Number.isFinite);
      const times = data.map(d=>d.time_tag);
      const latest = fluxes[fluxes.length-1];
      document.getElementById('xray-class').textContent = xrayClassFromFlux(latest);
      document.getElementById('xray-time').textContent = 'last GOES sample ' + fmtTime(times[times.length-1]);
      drawSpark(document.getElementById('xray-spark'), fluxes.slice(-180));
      // daily max (UTC)
      const todayUTC = new Date().toISOString().slice(0,10);
      let maxFlux = 0;
      for(let i=0;i<data.length;i++){
        if(String(data[i].time_tag).slice(0,10)===todayUTC){
          const f = Number(data[i].xrsb); if(isFinite(f)) maxFlux = Math.max(maxFlux, f);
        }
      }
      document.getElementById('xray-dmax').textContent = 'today max: ' + (maxFlux? xrayClassFromFlux(maxFlux) : '—');
      // update compact chip too
      const tiny = document.getElementById('tiny-xray'); if(tiny) tiny.textContent = xrayClassFromFlux(latest);
    }

    async function loadXray(){
      const url = 'https://services.swpc.noaa.gov/json/goes/primary/xrays-1-day.json';
      const res = await fetch(url, {cache:'no-cache'});
      const data = await res.json();
      const fluxes = data.map(d=>Number(d.xrsb)).filter(Number.isFinite);
      const times = data.map(d=>d.time_tag);
      const latest = fluxes[fluxes.length-1];
      document.getElementById('xray-class').textContent = xrayClassFromFlux(latest);
      document.getElementById('xray-time').textContent = 'last GOES sample ' + fmtTime(times[times.length-1]);
      drawSpark(document.getElementById('xray-spark'), fluxes.slice(-180));
    }

    // Solar wind (ACE 1‑minute) via SWPC products
    async function loadSolarWind(){
      const plasmaUrl = 'https://services.swpc.noaa.gov/products/solar-wind/ace-swepam-1-minute.json';
      const magUrl = 'https://services.swpc.noaa.gov/products/solar-wind/ace-magnetometer-1-minute.json';
      const [pRes, mRes] = await Promise.all([
        fetch(plasmaUrl, {cache:'no-cache'}), fetch(magUrl, {cache:'no-cache'})
      ]);
      const plasma = await pRes.json();
      const mag = await mRes.json();

      const pHeader = plasma[0].map(s=>String(s).toLowerCase());
      const mHeader = mag[0].map(s=>String(s).toLowerCase());
      const idx = (arr,name)=>arr.indexOf(name);
      const iTimeP = 0, iTimeM = 0;
      const iSpeed = idx(pHeader,'speed')>-1? idx(pHeader,'speed'): 3;
      const iDensity = idx(pHeader,'density')>-1? idx(pHeader,'density'): 1;
      const iBt = (idx(mHeader,'bt')>-1? idx(mHeader,'bt'): mHeader.length-1);
      const iBz = (idx(mHeader,'bz_gsm')>-1? idx(mHeader,'bz_gsm'): (idx(mHeader,'bz')>-1? idx(mHeader,'bz'): mHeader.length-2));

      const rowsP = plasma.slice(1);
      const rowsM = mag.slice(1);
      const lastP = rowsP[rowsP.length-1];
      const lastM = rowsM[rowsM.length-1];

      const speed = parseFloat(lastP[iSpeed]);
      const density = parseFloat(lastP[iDensity]);
      const bt = parseFloat(lastM[iBt]);
      const bz = parseFloat(lastM[iBz]);

      document.getElementById('sw-speed').textContent = isFinite(speed)? speed.toFixed(0): '—';
      document.getElementById('sw-density').textContent = isFinite(density)? density.toFixed(1): '—';
      document.getElementById('sw-bt').textContent = isFinite(bt)? bt.toFixed(1): '—';
      const bzEl = document.getElementById('sw-bz');
      if (isFinite(bz)){
        bzEl.textContent = bz.toFixed(1);
        bzEl.style.color = (bz < -3) ? 'var(--alert)' : (bz < 0 ? 'var(--warn)' : 'var(--ok)');
      } else { bzEl.textContent = '—'; }

      // compact chips
      const tiny = (id,val,fmt=x=>x)=>{ const el=document.getElementById(id); if(el && isFinite(val)) el.textContent = fmt(val); };
      tiny('tiny-speed', speed, v=>v.toFixed(0));
      tiny('tiny-density', density, v=>v.toFixed(1));
      tiny('tiny-bt', bt, v=>v.toFixed(1));
      tiny('tiny-bz', bz, v=>v.toFixed(1));

      // daily max (UTC) for speed, density, Bz, B
      const todayUTC = new Date().toISOString().slice(0,10);
      let maxSpeed=-Infinity, maxDensity=-Infinity, maxBt=-Infinity, maxBz=-Infinity;
      for(const r of rowsP){ if(String(r[iTimeP]).slice(0,10)===todayUTC){ const vS=parseFloat(r[iSpeed]); const vN=parseFloat(r[iDensity]); if(isFinite(vS)) maxSpeed=Math.max(maxSpeed,vS); if(isFinite(vN)) maxDensity=Math.max(maxDensity,vN); } }
      for(const r of rowsM){ if(String(r[iTimeM]).slice(0,10)===todayUTC){ const vBt=parseFloat(r[iBt]); const vBz=parseFloat(r[iBz]); if(isFinite(vBt)) maxBt=Math.max(maxBt,vBt); if(isFinite(vBz)) maxBz=Math.max(maxBz,vBz); } }
      const fmt = (v,dec=0)=> isFinite(v)? v.toFixed(dec): '—';
      document.getElementById('sw-speed-max').textContent = 'today max: ' + fmt(maxSpeed,0);
      document.getElementById('sw-density-max').textContent = 'today max: ' + fmt(maxDensity,1);
      document.getElementById('sw-bt-max').textContent = 'today max: ' + fmt(maxBt,1);
      document.getElementById('sw-bz-max').textContent = 'today max: ' + fmt(maxBz,1);

      // Speed spark line (last 2h)
      const speeds = rowsP.slice(-120).map(r=>parseFloat(r[iSpeed])).filter(v=>isFinite(v));
      drawSpark(document.getElementById('speed-spark'), speeds);
    }

    // Alerts feed (R,S,G scales etc.)
    async function loadAlerts(){
      const url = 'https://services.swpc.noaa.gov/products/alerts.json';
      const res = await fetch(url, {cache:'no-cache'});
      const data = await res.json();
      const root = document.getElementById('alerts');
      root.innerHTML = '';
      if(!Array.isArray(data) || data.length === 0){ root.textContent = 'No current alerts.'; return; }
      data.slice(-10).reverse().forEach(a=>{
        const div = document.createElement('div');
        div.style.marginBottom = '10px';
        const when = fmtTime(a.issue_datetime || a.message_issue_datetime || a.event_begin);
        const cat = a.product_id || a.message_type || 'Alert';
        const txt = a.message || a.summary || a.description || JSON.stringify(a);
        div.innerHTML = `<span class="chip">${cat}</span> <span class="sub">${when}</span><br/>${txt.replace(/
/g,'<br/>')}`;
        root.appendChild(div);
      });
    }

    // Helper to try multiple image URLs (SuperMAG / Kyoto sometimes change)
    function tryImages(imgEl, urls){
      let i = 0;
      function setNext(){
        if(i >= urls.length) return; // give up
        const t = Date.now();
        imgEl.src = urls[i] + (urls[i].includes('?') ? '&' : '?') + '_=' + t;
      }
      imgEl.onerror = ()=>{ i++; setNext(); };
      setNext();
    }

    function refreshAEAL(){
      const aeEl = document.getElementById('aeal-img');
      tryImages(aeEl, [
        // Candidate SuperMAG public plot URLs (24h AE/AL). Falls back if blocked.
        'https://supermag.jhuapl.edu/mag/lib/img/plot_ae_24h.png',
        'https://supermag.jhuapl.edu/mag/lib/img/plot_ae.png'
      ]);
    }

    function refreshSYM(){
      const sEl = document.getElementById('symh-img');
      tryImages(sEl, [
        // Candidate Kyoto WDC SYM-H quicklook images
        'https://wdc.kugi.kyoto-u.ac.jp/aeasy/real_time_symh.png',
        'https://wdc.kugi.kyoto-u.ac.jp/aeasy/rt_symh.png'
      ]);
    }

    async function refresh(){
      try{ await Promise.all([loadKp(), loadXray(), loadSolarWind(), loadAlerts()]); }
      catch(e){ console.error(e); }
      finally{ setUpdated(); }
    }

    function refreshAuroraImages(){
      const t = Date.now();
      for (const id of ['aurora-nh','aurora-sh']){
        const img = document.getElementById(id);
        const base = img.src.split('?')[0];
        img.src = base + '?_=' + t;
      }
    }

    refresh();
    refreshAEAL();
    refreshSYM();
    refreshAuroraImages();
    setInterval(refresh, 60*1000);
    setInterval(refreshAEAL, 5*60*1000);
    setInterval(refreshSYM, 5*60*1000);
    setInterval(refreshAuroraImages, 60*1000);
  </script>
</body>
</html>
